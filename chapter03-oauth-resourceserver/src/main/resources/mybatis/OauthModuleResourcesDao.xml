<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.wudimanong.oauth.resource.dao.mapper.OauthModuleResourcesDao">
    <resultMap id="BaseResultMap" type="com.wudimanong.oauth.entity.model.OauthModuleResources">
        <id column="MODULE_ID" property="moduleId" jdbcType="VARCHAR"/>
        <result column="MODULE_NAME" property="moduleName" jdbcType="VARCHAR"/>
        <result column="MODULE_CODE" property="moduleCode" jdbcType="VARCHAR"/>
        <result column="MODULE_PATH" property="modulePath" jdbcType="VARCHAR"/>
        <result column="PARENT_ID" property="parentId" jdbcType="VARCHAR"/>
        <result column="MODULE_ICON" property="moduleIcon" jdbcType="VARCHAR"/>
        <result column="HTTP_METHOD" property="httpMethod" jdbcType="VARCHAR"/>
        <result column="IS_OPERATING" property="isOperating" jdbcType="INTEGER"/>
        <result column="SORT" property="sort" jdbcType="INTEGER"/>
        <result column="SYSTEM_ID" property="systemId" jdbcType="VARCHAR"/>
        <result column="ACTIVE" property="active" jdbcType="INTEGER"/>
        <result column="CREATE_DATE" property="createDate" jdbcType="TIMESTAMP"/>
        <result column="UPDATE_DATE" property="updateDate" jdbcType="TIMESTAMP"/>
    </resultMap>

    <resultMap id="menuMap" type="com.wudimanong.oauth.entity.model.OauthModuleResources">
        <id column="MODULE_ID" property="moduleId" jdbcType="VARCHAR"/>
        <result column="MODULE_NAME" property="moduleName" jdbcType="VARCHAR"/>
        <result column="MODULE_CODE" property="moduleCode" jdbcType="VARCHAR"/>
        <result column="MODULE_PATH" property="modulePath" jdbcType="VARCHAR"/>
        <result column="PARENT_ID" property="parentId" jdbcType="VARCHAR"/>
        <result column="MODULE_ICON" property="moduleIcon" jdbcType="VARCHAR"/>
        <result column="HTTP_METHOD" property="httpMethod" jdbcType="VARCHAR"/>
        <result column="IS_OPERATING" property="isOperating" jdbcType="INTEGER"/>
        <result column="SORT" property="sort" jdbcType="INTEGER"/>
        <result column="SYSTEM_ID" property="systemId" jdbcType="VARCHAR"/>
        <result column="ACTIVE" property="active" jdbcType="INTEGER"/>
        <result column="CREATE_DATE" property="createDate" jdbcType="TIMESTAMP"/>
        <result column="UPDATE_DATE" property="updateDate" jdbcType="TIMESTAMP"/>
        <collection column="{parentId=MODULE_ID,userId=USER_ID}" property="subModules"
                select="com.wudimanong.oauth.resource.dao.mapper.OauthModuleResourcesDao.selectMenusByParentIdWithOperating"/>
    </resultMap>

    <resultMap id="rolesMap" type="com.wudimanong.oauth.entity.model.OauthModuleResources">
        <id column="MODULE_ID" property="moduleId" jdbcType="VARCHAR"/>
        <result column="MODULE_NAME" property="moduleName" jdbcType="VARCHAR"/>
        <result column="MODULE_CODE" property="moduleCode" jdbcType="VARCHAR"/>
        <result column="MODULE_PATH" property="modulePath" jdbcType="VARCHAR"/>
        <result column="PARENT_ID" property="parentId" jdbcType="VARCHAR"/>
        <result column="MODULE_ICON" property="moduleIcon" jdbcType="VARCHAR"/>
        <result column="HTTP_METHOD" property="httpMethod" jdbcType="VARCHAR"/>
        <result column="IS_OPERATING" property="isOperating" jdbcType="INTEGER"/>
        <result column="SORT" property="sort" jdbcType="INTEGER"/>
        <result column="SYSTEM_ID" property="systemId" jdbcType="VARCHAR"/>
        <result column="ACTIVE" property="active" jdbcType="INTEGER"/>
        <result column="CREATE_DATE" property="createDate" jdbcType="TIMESTAMP"/>
        <result column="UPDATE_DATE" property="updateDate" jdbcType="TIMESTAMP"/>
        <collection column="{parentId=MODULE_ID,userId=USER_ID}" property="subModules" select="selectModuleByParentId"/>
    </resultMap>

    <resultMap id="moduleTree" type="com.wudimanong.oauth.entity.model.OauthModuleResources">
        <id column="MODULE" property="moduleId" jdbcType="VARCHAR"/>
        <result column="MODULE_NAME" property="moduleName" jdbcType="VARCHAR"/>
        <result column="MODULE_CODE" property="moduleCode" jdbcType="VARCHAR"/>
        <result column="MODULE_PATH" property="modulePath" jdbcType="VARCHAR"/>
        <result column="PARENT_ID" property="parentId" jdbcType="VARCHAR"/>
        <result column="MODULE_ICON" property="moduleIcon" jdbcType="VARCHAR"/>
        <result column="HTTP_METHOD" property="httpMethod" jdbcType="VARCHAR"/>
        <result column="IS_OPERATING" property="isOperating" jdbcType="INTEGER"/>
        <result column="SORT" property="sort" jdbcType="INTEGER"/>
        <result column="SYSTEM_ID" property="systemId" jdbcType="VARCHAR"/>
        <result column="ACTIVE" property="active" jdbcType="INTEGER"/>
        <result column="CREATE_DATE" property="createDate" jdbcType="TIMESTAMP"/>
        <result column="UPDATE_DATE" property="updateDate" jdbcType="TIMESTAMP"/>
        <collection column="{ID=ID}" property="subModules" select="selectModuleTreeByParentId"/>
    </resultMap>

    <select id="getMenusByUserId" resultMap="menuMap">
    SELECT DISTINCT bmr.*, bur.user_id as USER_ID FROM
    oauth_user_role bur LEFT JOIN oauth_role_module brm ON bur.role_id = brm.role_id
    LEFT JOIN oauth_module_resources bmr ON brm.module_id = bmr.module_id
    LEFT JOIN oauth_system bs ON  bmr.SYSTEM_ID = bs.SYSTEM_ID
    WHERE bur.user_id = #{userId} AND bmr.parent_id IS NULL AND bmr.IS_OPERATING = 0 AND bs.ACTIVE = 1
  </select>

    <select id="selectMenusByParentIdWithOperating" resultMap="menuMap">
    SELECT DISTINCT bmr.*, bur.user_id as USER_ID FROM
    oauth_user_role bur LEFT JOIN oauth_role_module brm ON bur.role_id = brm.role_id
    LEFT JOIN oauth_module_resources bmr ON brm.module_id = bmr.module_id
    WHERE bur.user_id = #{userId} AND bmr.parent_id = #{parentId} AND bmr.IS_OPERATING = 0
  </select>

    <select id="selectModuleByRoleId" resultMap="rolesMap">
    SELECT bmr.*, bur.user_id as USER_ID, bs.PROJECT_NAME FROM oauth_role_module brm
    LEFT JOIN oauth_module_resources bmr on brm.MODULE_ID = bmr.MODULE_ID
    LEFT JOIN oauth_system bs ON  bmr.SYSTEM_ID = bs.SYSTEM_ID
    LEFT JOIN oauth_user_role bur ON bur.role_id = brm.role_id
    WHERE brm.ROLE_ID = #{roleId} and bur.user_id = #{userId} and bmr.parent_id is null and bs.ACTIVE = 1
  </select>

    <select id="selectModuleByParentId" resultMap="rolesMap">
     SELECT DISTINCT bmr.*, bur.user_id as USER_ID, bs.PROJECT_NAME FROM oauth_user_role bur
     LEFT JOIN oauth_role_module brm ON bur.role_id = brm.role_id
     LEFT JOIN oauth_module_resources bmr ON brm.module_id = bmr.module_id
     LEFT JOIN oauth_system bs ON  bmr.SYSTEM_ID = bs.SYSTEM_ID
     WHERE bur.user_id = #{userId} AND bmr.parent_id = #{parentId}
   </select>

    <select id="selectModuleTree" resultMap="moduleTree">
        SELECT * FROM oauth_module_resources
        <where>
            <if test="id == 'root'">
                PARENT_ID IS NULL AND SYSTEM_ID = #{systemId}
            </if>
            <if test="id != 'root'">
                PARENT_ID = #{id}
            </if>
        </where>
    </select>
</mapper>